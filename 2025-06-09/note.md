# lecture 6学习笔记任务分配与图划分

## 1. 并行计算的性能与瓶颈

### 1.1 加速比 (Speedup)

- **定义**: 加速比 $S$ 是衡量并行化效果的指标，其计算公式为：$$ S = \frac{T_{s}}{T_{p}} $$ 其中，$T_s$ 是单处理器执行时间，$T_p$ 是使用 p 个处理器并行执行的时间。
- **理想与现实**: 理想情况下，使用 p 个处理器能获得 p 倍的加速比。 但在实践中，实际加速比通常小于理想值，并且随着处理器数量的增加，与理想值的差距可能变大。

### 1.2 造成并行效率低下的原因

- **负载不均衡 (Load imbalance)**: 各处理器分配到的工作量（包括计算和通信）不同。
- **并行开销过大 (Parallelism overhead)**: 例如同步、通信和冗余计算等。
- **单处理器性能不佳**: 通常瓶颈在于内存系统。
- **计算资源速度差异**: 例如在一个 `CPU+GPU` 的异构系统上。

## 2. 任务分配策略

根据阿姆达尔定律，即使是少量的负载不均衡也会严重限制最大加速比。 因此，需要良好的任务分配策略来平衡各处理单元的负载。

### 2.1 静态任务分配 (Static Task Assignment)

- **定义**: 在程序运行前预先确定好任务到处理器/线程的分配方式。
- **优点**: 实现简单，没有运行时开销。
- **适用场景**: 适用于工作负载可预测的场景。 例如，稠密矩阵计算、规则网格等问题可以轻易地分解为大小相等的任务。
- **挑战**: 对于稀疏矩阵、非结构化网格和图等问题，任务分配较为复杂，需要仔细考虑负载均衡、最小化通信开销和冗余计算。

### 2.2 动态任务分配 (Dynamic Task Assignment)

- 也称为动态作业调度或动态负载均衡。

## 3. 图划分 (Graph Partitioning)

图划分是将一个大图分解为若干个小图的过程，是许多并行计算问题中至关重要的预处理步骤。

### 3.1 定义与目标

- **输入**: 一个图 $G=(N,E,W_{N},W_{E})$，其中 N 是顶点（带权重 $W_N$），E 是边（带权重 $W_E$）。
    - 例如：顶点可代表任务，顶点权重代表任务成本；边代表任务间的数据依赖，边权重代表通信数据量。
- **目标**: 将顶点集 N 划分为 $N_1 \cup N_2 \cup \dots \cup N_p$，同时满足两个条件：
    1.  **负载均衡**: 每个子集 $N_i$ 的顶点权重之和大致相等。
    2.  **通信最小化**: 连接不同子集 $N_i$ 和 $N_j$ 之间的边的权重之和（即 "edge cut"）最小化。
- **复杂度**: 图划分通常是一个 NP 难问题，因此在实践中需要依赖高效的启发式算法。

### 3.2 依赖几何信息的划分方法

当图的顶点具有几何坐标信息时（例如在 PDE 求解中），可以利用这些信息进行划分。

#### a. 坐标二分法 (Coordinate Bisection)

- **方法**: 选择一个垂直于某个坐标轴（如 x 轴）的超平面，将顶点平分为两部分。 在递归划分时，可以交替选择 x、y、z 轴进行划分，以获得更好的长宽比和可能更小的切割边。
- **缺点**: 该方法严重依赖于坐标系。对同一个几何结构，仅仅旋转一下坐标系，就可能导致完全不同的、甚至很差的划分结果。

#### b. 惯性二分法 (Inertial Bisection)

- **核心思想**: 寻找一个超平面，使得所有顶点到该平面的距离平方和最小。 这种方法通过旋转坐标系来找到最优的划分方向。
- **实现步骤**:
    1.  **平移**: 将坐标原点移动到所有顶点的质心 $(\overline{x}, \overline{y})$。
    2.  **旋转**: 寻找一个旋转角度 $\theta$，使得新的坐标系下所有顶点的 $x''$ 坐标的平方和最小。
    3.  **求解**: 这个问题可以被形式化为一个矩阵特征值问题。最小化距离平方和等价于寻找下面这个 $2 \times 2$ 惯性张量矩阵的最小特征值所对应的特征向量 `u`。
        $$ \sum d_i^2 = u^T \begin{bmatrix} s_{xx} & s_{xy} \\ s_{xy} & s_{yy} \end{bmatrix} u $$
        其中 $s_{xx} = \sum(x_i - \overline{x})^2$, $s_{yy} = \sum(y_i - \overline{y})^2$, $s_{xy} = \sum(x_i - \overline{x})(y_i - \overline{y})$。 该特征向量 `u` 的方向就是最佳划分线的法线方向。

### 3.3 不依赖几何信息的划分方法

对于很多实际问题（如万维网图模型），图的顶点没有几何信息，此时需要使用不同的划分算法。

### 3.4 算法选择的权衡

- **时间 vs. 质量**: 划分算法的选择需要在运行时间和划分质量之间做权衡。
- **应用决定选择**:
    - 对于 VLSI 设计，高质量的划分能直接节省成本，因此倾向于选择能产出优质解的慢速算法。
    - 对于稀疏矩阵计算，我们更关心总执行时间。划分算法本身消耗的时间必须少于通过并行化节省的时间。
- **结论**: 不存在适用于所有情况的“最佳”算法。

## 4. OpenMP 中的 schedule 子句

`schedule` 子句用于描述循环的迭代如何分配给线程。

- **`schedule(static[, chunk])`**
    - **机制**: 将迭代以大小为 `chunk` 的块为单位，静态地、轮流地分配给每个线程。 这种分配在编译时确定，运行时开销最小。
    - **示例**:
        - `schedule(static)`: 默认的块划分。
        - `schedule(static, 1)`: 循环划分 (Cyclic Partitioning)。

- **`schedule(dynamic[, chunk])`**
    - **机制**: 线程动态地从一个任务队列中获取 `chunk` 大小的迭代块来执行，直到所有迭代都被处理完毕。 这种调度逻辑在运行时执行。
    - **适用场景**: 当每次迭代的工作量不可预测或变化很大时非常有用。
